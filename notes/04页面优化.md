
### 页面优化



**页面缓存**

**将 “具有静态属性” 页面放在 redis 缓存中**

比如 商品列表页、商品详情页

重点：设置一定的过期时间

应用场景：不怎么变更的页面（**分页**的情况，只进行 前边几页的分页）



登陆页面：

```java
@GetMapping(value = "", produces = "text/html;charset=utf-8")
@ResponseBody
public String login(@CookieValue(value = "user_ticket", required = false) String ticket,
                    HttpServletRequest request,
                    HttpServletResponse response) {

    if (StringUtils.hasLength(ticket)) {//有ticket则重定向到 “首页”
        return "<script>location.href='/goods/toList'</script>";
    }

    ValueOperations opsFV = redisTemplate.opsForValue();
    Object html = opsFV.get("html:login");
    if (null == html) {
        WebContext context = new WebContext(request, response, request.getServletContext(), request.getLocale());
        html = thymeleafViewResolver.getTemplateEngine().process("login", context);
        opsFV.set("html:login", html, 10, TimeUnit.SECONDS);//设置过期时间
    }

    return (String) html;
}
```

商品列表页面：

```java
@RequestMapping(value = "/toList", produces = "text/html;charset=utf-8")
@ResponseBody
public String list(User user,       // 在 controller 入口之前做校验
                   Model model,
                   HttpServletRequest request,
                   HttpServletResponse response) throws IOException {

    if (null == user) {
        CookieUtil.deleteCookie(request, response, "user_ticket");//过期cookie导致，清除cookie
        return "<script>location.href='/login'</script>";//重定向
    }

    ValueOperations opsFV = redisTemplate.opsForValue();
    Object html = opsFV.get("html:goods:toList");

    if (null != html) return (String) html;

    model.addAttribute("user", user);//用户信息
    List<GoodsVo> goodsVoList = goodsService.findAllGoodsVo();
    model.addAttribute("goodsList", goodsVoList);//商品列表

    WebContext context = new WebContext(request, response, request.getServletContext(), request.getLocale(), model.asMap());
    html = thymeleafViewResolver.getTemplateEngine().process("goodsList", context);
    opsFV.set("html:goods:toList", html, 10, TimeUnit.SECONDS);

    return (String) html;
}
```

商品详情页：

```java
@RequestMapping("/toDetail/{goodsId}")
@ResponseBody
public String detail(@PathVariable Long goodsId, User user, Model model,
                     HttpServletRequest request,
                     HttpServletResponse response) {

    if (null == user) {
        CookieUtil.deleteCookie(request, response, "user_ticket");//过期cookie导致，清除cookie
        return "<script>location.href='/login'</script>";
    }

    GoodsVo goodsVo = goodsService.findGoodsVoByGoodsId(goodsId);
    model.addAttribute("user", user);
    model.addAttribute("goods", goodsVo);
    //.....

    ValueOperations opsFV = redisTemplate.opsForValue();
    Object html = opsFV.get("html:goods:toDetail" + goodsId);

    if (null != html) return (String) html;

    WebContext context = new WebContext(request, response, request.getServletContext(), request.getLocale(), model.asMap());
    html = thymeleafViewResolver.getTemplateEngine().process("goodsDetail", context);
    opsFV.set("html:goods:toDetail" + goodsId, html, 10, TimeUnit.SECONDS);

    return (String) html;
}
```





**对象缓存**

**将重要的信息 vo 存放在 redis 中**

比如用户信息：登录时将用户信息进行缓存，doLogin() 中

```java
redisTemplate.opsForValue().set("user_ticket:" + ticket, user, 1, TimeUnit.HOURS);
```

用户访问接口时，先从 redis 中取他的信息：

```java
@Override
public Object resolveArgument(MethodParameter parameter, ModelAndViewContainer mavContainer, NativeWebRequest webRequest, WebDataBinderFactory binderFactory) throws Exception {

    HttpServletRequest request = webRequest.getNativeRequest(HttpServletRequest.class);

    String ticket = CookieUtil.getCookieValue(request, "user_ticket");

    if (StringUtils.hasLength(ticket)) {
        return userService.getUserInfoByTicket(ticket);
    }
    return null;
}


@Override
public User getUserInfoByTicket(String ticket) {

    if (!StringUtils.hasLength(ticket))
        return null;

    return (User) redisTemplate.opsForValue().get("user_ticket:" + ticket);//从redis中拿
}
```

<img src="images/04页面优化.assets/image-20210818220245121.png" alt="image-20210818220245121" style="zoom:80%;" />

